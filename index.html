<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>STOCK COUNT</title>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <!-- XLSX -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* CSS Styles */
    :root{
      --accent:#d35400;
      --accent-light:#e67e22;
      --accent-dark:#a04000;
      --bg1:#fff8f2;
      --bg2:#ffd1a4;
      --muted:#666;
      --card:#fff;
      --ok:#27ae60;
      --warn:#c0392b;
      --warning:#e67e22;
      --text:#2c3e50;
      --text-light:#7f8c8d;
      --border:#e0e0e0;
    }
    *{box-sizing:border-box}
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      margin:0; 
      padding:0; 
      background: linear-gradient(135deg,var(--bg1),var(--bg2)); 
      color:var(--text); 
      line-height:1.6;
    }
    
    .main-header {
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      color:#fff;
      padding: 18px 20px;
      text-align:center;
      font-size:28px;
      font-weight:700;
      box-shadow:0 6px 18px rgba(0,0,0,.15);
      position: relative;
      border-bottom: 4px solid rgba(255,255,255,0.2);
    }
    
    .user-role-badge {
      position: absolute;
      top: 50%;
      right: 20px;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.2);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      backdrop-filter: blur(5px);
    }
    
    .container { 
      max-width:1200px; 
      margin:0 auto; 
      padding: 20px;
    }
    
    .card {
      background: var(--card);
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,.08);
      overflow: hidden;
      margin-bottom: 20px;
      border: 1px solid rgba(0,0,0,0.05);
    }
    
    .card-header {
      background: linear-gradient(90deg, #ffe5cc, #ffc18a);
      padding: 15px 20px;
      font-weight: 700;
      color: #4a2d16;
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    
    .card-body {
      padding: 20px;
    }
    
    .btn {
      padding: 10px 16px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    .btn-primary {
      background: var(--accent);
      color: white;
      box-shadow: 0 4px 12px rgba(211, 84, 0, 0.2);
    }
    
    .btn-primary:hover {
      background: var(--accent-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(211, 84, 0, 0.3);
    }
    
    .btn-secondary {
      background: #3498db;
      color: white;
      box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
    }
    
    .btn-secondary:hover {
      background: #2980b9;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(52, 152, 219, 0.3);
    }
    
    .btn-danger {
      background: var(--warn);
      color: white;
      box-shadow: 0 4px 12px rgba(192, 57, 43, 0.2);
    }
    
    .btn-danger:hover {
      background: #a93226;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(192, 57, 43, 0.3);
    }
    
    .btn-warning {
      background: var(--warning);
      color: white;
      box-shadow: 0 4px 12px rgba(230, 126, 34, 0.2);
    }
    
    .btn-warning:hover {
      background: #d35400;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(230, 126, 34, 0.3);
    }
    
    .btn-small {
      padding: 8px 12px;
      font-size: 13px;
      border-radius: 6px;
    }
    
    .btn-outline {
      background: transparent;
      border: 2px solid var(--accent);
      color: var(--accent);
    }
    
    .btn-outline:hover {
      background: var(--accent);
      color: white;
    }
    
    .form-group {
      margin-bottom: 15px;
      position: relative;
    }
    
    .form-label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--text);
      font-size: 14px;
    }
    
    .form-control {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(211, 84, 0, 0.1);
    }
    
    .password-toggle {
      position: absolute;
      right: 12px;
      top: 38px;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--muted);
      font-size: 18px;
    }
    
    .password-toggle:hover {
      color: var(--accent);
    }
    
    .row { 
      display:flex; 
      gap:15px; 
      flex-wrap:wrap; 
      align-items:center; 
      margin-bottom:15px; 
    }
    
    table { 
      width:100%; 
      border-collapse:collapse; 
      margin-top:10px; 
      background:var(--card); 
      border-radius:12px; 
      overflow:hidden; 
      box-shadow:0 8px 30px rgba(0,0,0,.06); 
    }
    
    thead { 
      background:linear-gradient(90deg, #ffe5cc, #ffc18a); 
    }
    
    th, td { 
      padding:14px 12px; 
      border-bottom:1px solid rgba(0,0,0,0.04); 
      text-align:center; 
      font-size:14px; 
      vertical-align:middle; 
    }
    
    th { 
      font-weight:700; 
      color:#4a2d16; 
      text-transform:uppercase; 
      letter-spacing:0.6px; 
      font-size:13px; 
    }
    
    td { 
      background: rgba(255,255,255,0.98); 
      color:var(--text); 
    }
    
    tbody tr:nth-child(odd){ 
      background: rgba(249,245,242,0.8); 
    }
    
    tbody tr:hover { 
      background: rgba(255,244,229,0.9); 
      transform: translateZ(0); 
    }
    
    #app-logo { 
      width: 120px;
      height: auto;
      border-radius: 12px;
      object-fit: contain;
      cursor: pointer;
      display: block;
      margin: 0 auto 8px;
      background: #fff;
      padding: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,.06);
      transition: all 0.3s ease;
    }
    
    #app-logo:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0,0,0,.1);
    }

    .num-input { 
      width:96px; 
      padding:8px; 
      border-radius:6px; 
      text-align:right; 
      border: 1px solid var(--border);
    }
    
    .status { 
      margin-top:8px; 
      color:green; 
      font-weight:600; 
    }
    
    .hidden { 
      display:none; 
    }
    
    .hint { 
      color:var(--text-light); 
      font-size:13px; 
      margin-top:8px; 
    }
    
    .shelf-controls { 
      display:flex; 
      gap:8px; 
      align-items:center; 
    }
    
    .muted { 
      color:var(--muted); 
      font-size:13px; 
    }
    
    .badge { 
      display:inline-block; 
      padding:6px 10px; 
      border-radius:999px; 
      font-weight:700; 
      color:#fff; 
      min-width:48px; 
      text-align:center; 
    }
    
    .badge-ok { 
      background: var(--ok); 
    }
    
    .badge-low { 
      background: var(--warn); 
    }
    
    .badge-warning { 
      background: var(--warning); 
    }
    
    .order-flag { 
      display:block; 
      margin-top:6px; 
      font-size:12px; 
      font-weight:700; 
      color:var(--warn); 
    }
    
    .warning-flag { 
      display:block; 
      margin-top:6px; 
      font-size:12px; 
      font-weight:700; 
      color:var(--warning); 
    }
    
    .apply-btn { 
      margin-left:8px; 
      background:#1976d2; 
      padding:8px 12px; 
      font-size:13px; 
      border-radius:6px; 
    }
    
    .row-actions { 
      display:flex; 
      gap:6px; 
      align-items:center; 
      justify-content:center; 
    }
    
    .note { 
      font-size:13px; 
      color:#5b4638; 
    }
    
    .col-shelf { 
      font-weight:600; 
      color:#4a2d16; 
    }

    .clickable-row { 
      cursor: pointer; 
      transition: all 0.2s ease;
    }
    
    .clickable-row:hover { 
      background: rgba(255,244,229,0.9) !important;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .clickable-row.active { 
      background: rgba(255,235,200,0.9) !important;
      border-left: 4px solid var(--accent);
    }

    .low-stock-row { 
      background: rgba(230, 126, 34, 0.1) !important; 
      border-left:4px solid var(--warning); 
    }
    
    .low-stock-row:hover { 
      background: rgba(230, 126, 34, 0.15) !important; 
    }
    
    .stock-warning { 
      color:var(--warning); 
      font-weight:600; 
      font-size:12px; 
    }

    #item-detail-panel {
      position: fixed;
      top: 0;
      right: -400px;
      width: 380px;
      height: 100vh;
      background: white;
      box-shadow: -4px 0 20px rgba(0,0,0,0.15);
      transition: right 0.3s ease;
      z-index: 1000;
      overflow-y: auto;
      padding: 20px;
    }
    
    #item-detail-panel.open {
      right: 0;
    }
    
    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #eee;
    }
    
    .detail-title {
      font-size: 18px;
      font-weight: 700;
      color: #333;
    }
    
    .close-detail {
      background: #d32f2f;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    
    .detail-section {
      margin-bottom: 20px;
    }
    
    .detail-label {
      font-weight: 600;
      color: #666;
      margin-bottom: 5px;
      font-size: 14px;
    }
    
    .detail-value {
      font-size: 16px;
      color: #333;
      margin-bottom: 15px;
    }
    
    .detail-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    #history-modal{ 
      position:fixed; 
      inset:0; 
      display:none; 
      align-items:center; 
      justify-content:center; 
      background:rgba(0,0,0,0.4); 
      z-index:9999; 
    }
    
    #history-panel{ 
      width:800px; 
      max-width:95%; 
      max-height:85vh; 
      overflow:auto; 
      background:#fff; 
      border-radius:12px; 
      padding:20px; 
      box-shadow:0 8px 32px rgba(0,0,0,.3); 
    }
    
    #history-panel h3{ 
      margin:0 0 15px 0; 
      font-size:20px; 
      color:#333; 
      border-bottom:2px solid #eee; 
      padding-bottom:10px; 
    }

    /* PERBAIKAN: Dashboard cards layout yang responsif */
    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .dashboard-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      text-align: center;
      transition: all 0.3s ease;
      border-left: 5px solid var(--accent);
      min-height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    
    .dashboard-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    }
    
    .card-title {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
      text-transform: uppercase;
      font-weight: 600;
    }
    
    .card-value {
      font-size: 28px;
      font-weight: 700;
      color: #333;
      margin-bottom: 5px;
    }
    
    .card-subtitle {
      font-size: 12px;
      color: #888;
    }

    .quick-actions {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .quick-action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: white;
      border: none;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.08);
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 100px;
      text-align: center;
      flex: 1;
      max-width: 140px;
    }
    
    .quick-action-btn:hover {
      background: var(--accent);
      color: white;
      transform: translateY(-3px);
    }
    
    .quick-action-btn i {
      font-size: 24px;
      margin-bottom: 8px;
    }
    
    .quick-action-btn span {
      font-size: 12px;
      font-weight: 600;
    }

    .filter-panel {
      background: white;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.08);
    }
    
    .filter-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #333;
    }
    
    .filter-row {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .filter-label {
      font-size: 12px;
      color: #666;
      font-weight: 600;
    }

    .bottom-bar { 
      display:flex; 
      justify-content:space-between; 
      align-items:center; 
      gap:12px; 
      margin-top:16px; 
      flex-wrap:wrap; 
    }
    
    .controls-left, .controls-center, .controls-right { 
      display:flex; 
      gap:8px; 
      align-items:center; 
      flex-wrap:wrap; 
    }
    
    .controls-left { 
      flex:1; 
    }
    
    .controls-center { 
      justify-content:center; 
      flex:1; 
    }
    
    .controls-right { 
      justify-content:flex-end; 
      flex:1; 
    }

    /* PERBAIKAN: Modal untuk Stats */
    #stats-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px;
    }
    
    #stats-modal.open {
      display: flex;
    }
    
    .stats-modal-content {
      background: white;
      border-radius: 12px;
      width: 95%;
      height: 90%;
      max-width: 1400px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    
    .stats-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 2px solid #eee;
      background: #f8f8f8;
      flex-shrink: 0;
    }
    
    .stats-modal-title {
      font-size: 24px;
      font-weight: 700;
      color: #333;
      margin: 0;
    }
    
    .stats-modal-close {
      background: #d32f2f;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
    }
    
    .stats-modal-body {
      flex: 1;
      padding: 20px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
    }

    .stats-tabs {
      display: flex;
      margin-bottom: 16px;
      border-bottom: 2px solid #e0e0e0;
      flex-shrink: 0;
    }
    
    .stats-tab {
      padding: 10px 20px;
      background: #f5f5f5;
      border: none;
      cursor: pointer;
      font-weight: 600;
      color: #666;
      transition: all 0.3s ease;
      border-radius: 6px 6px 0 0;
      margin-right: 4px;
    }
    
    .stats-tab.active {
      background: var(--accent);
      color: white;
    }
    
    .stats-tab-content {
      display: none;
      flex: 1;
      overflow: hidden;
    }
    
    .stats-tab-content.active {
      display: flex;
      flex-direction: column;
    }

    /* PERBAIKAN UTAMA: Container untuk chart vertikal */
    .vertical-chart-container {
      position: relative;
      width: 100%;
      height: 100%;
      overflow-x: auto;
      overflow-y: hidden;
      padding-bottom: 10px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      background: white;
      scroll-behavior: smooth;
      flex: 1;
    }
    
    .vertical-chart-wrapper {
      position: relative;
      height: 100%;
      padding: 20px;
      min-width: 800px;
    }
    
    .vertical-chart-canvas {
      display: block !important;
    }
    
    .scroll-indicator {
      position: absolute;
      bottom: 8px;
      right: 8px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      z-index: 10;
      pointer-events: none;
    }

    .chart-header-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
      flex-shrink: 0;
    }
    
    .chart-open-btn {
      background: #1976d2;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
      transition: all 0.3s ease;
    }
    
    .chart-open-btn:hover {
      background: #1565c0;
    }

    /* PERBAIKAN: Style untuk tombol export history */
    .export-history-btn {
      background: #27ae60 !important;
      color: white !important;
      border: none !important;
      padding: 8px 12px !important;
      border-radius: 6px !important;
      font-size: 13px !important;
      font-weight: 600 !important;
      cursor: pointer !important;
      margin-right: 8px !important;
      transition: all 0.3s ease !important;
    }

    .export-history-btn:hover {
      background: #219955 !important;
      transform: translateY(-1px) !important;
    }

    /* PERBAIKAN: Responsive styles */
    @media (max-width: 768px) {
      .dashboard-cards {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 600px) {
      .dashboard-cards {
        grid-template-columns: 1fr;
      }
      
      #item-detail-panel {
        width: 100%;
        right: -100%;
      }
      
      .stats-tabs {
        flex-direction: column;
      }
      
      .stats-tab {
        border-radius: 6px;
        margin-bottom: 4px;
      }
      
      .chart-header-actions {
        flex-direction: column;
        gap: 4px;
      }
      
      .stats-modal-body {
        padding: 10px;
      }
      
      .vertical-chart-wrapper {
        padding: 10px;
      }
      
      .quick-actions {
        justify-content: flex-start;
      }
      
      .quick-action-btn {
        min-width: 80px;
        max-width: 100px;
      }
    }

    @media (max-width:1100px){
      .num-input{width:72px}
      th:nth-child(2), td:nth-child(2){ text-align:left; }
    }
    
    @media (max-width:700px){
      table, thead, tbody, th, td, tr { display:block; }
      thead { display:none; }
      tr{ margin-bottom:10px; border-radius:8px; background:#fff; padding:8px; }
      td{ display:flex; justify-content:space-between; padding:6px 8px; border-bottom:1px dashed rgba(0,0,0,.06); }
      td::before{ font-weight:700; color:#4a2d16; margin-right:8px; }
      td:nth-of-type(1)::before{ content:"No"; }
      td:nth-of-type(2)::before{ content:"Item Name"; width:1px; flex:1; }
      td:nth-of-type(3)::before{ content:"Initial Stock"; }
      td:nth-of-type(4)::before{ content:"In"; }
      td:nth-of-type(5)::before{ content:"Out"; }
      td:nth-of-type(6)::before{ content:"Shelf"; }
      td:nth-of-type(7)::before{ content:"Final Stock"; }
      td:nth-of-type(8)::before{ content:"Actions"; }
      .row-actions { gap:8px; }
      .controls-right { justify-content:center; }
    }
  </style>
</head>
<body>
  <header class="main-header">
    STOCK COUNT
    <div id="user-role-badge" class="user-role-badge hidden">User</div>
  </header>
  
  <div class="container">
    <div id="logo-wrap" style="text-align:center; display:none;">
      <img id="app-logo" src="" alt="App Logo (admin can change)" title="Admin: click to change logo. Users: view only.">
      <input id="logo-file" type="file" accept="image/*" class="hidden">
    </div>

    <div id="auth-section" class="card">
      <div class="card-header">Sign up / Sign in</div>
      <div class="card-body">
        <div class="form-group">
          <label class="form-label" for="email">Email</label>
          <input id="email" type="email" class="form-control" placeholder="Email">
        </div>
        <div class="form-group">
          <label class="form-label" for="password">Password</label>
          <input id="password" type="password" class="form-control" placeholder="Password">
          <button type="button" class="password-toggle" id="password-toggle">
            <i class="fas fa-eye"></i>
          </button>
        </div>
        <div class="form-group">
          <label class="form-label" for="admin-code">Admin Code (optional)</label>
          <input id="admin-code" type="text" class="form-control" placeholder="Admin code (optional)">
        </div>
        <div class="row">
          <button id="signup" class="btn btn-primary">Sign up</button>
          <button id="login" class="btn btn-secondary">Sign in</button>
        </div>
        <div id="auth-status" class="status"></div>
      </div>
    </div>

    <div id="app-section" class="hidden">
      <!-- Dashboard Cards -->
      <div class="dashboard-cards">
        <div class="dashboard-card">
          <div class="card-title">Total Items</div>
          <div class="card-value" id="total-items">0</div>
          <div class="card-subtitle">All shelves</div>
        </div>
        <div class="dashboard-card">
          <div class="card-title">Low Stock Items</div>
          <div class="card-value" id="low-stock-items">0</div>
          <div class="card-subtitle">Need restocking</div>
        </div>
        <div class="dashboard-card">
          <div class="card-title">Out of Stock</div>
          <div class="card-value" id="out-of-stock">0</div>
          <div class="card-subtitle">No stock available</div>
        </div>
        <div class="dashboard-card">
          <div class="card-title">Total Shelves</div>
          <div class="card-value" id="total-shelves">0</div>
          <div class="card-subtitle">Storage locations</div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="quick-actions">
        <button class="quick-action-btn" id="quick-add-item">
          <i class="fas fa-plus-circle"></i>
          <span>Add Item</span>
        </button>
        <button class="quick-action-btn" id="quick-view-stats">
          <i class="fas fa-chart-bar"></i>
          <span>View Stats</span>
        </button>
        <button class="quick-action-btn" id="quick-low-stock">
          <i class="fas fa-exclamation-triangle"></i>
          <span>Low Stock</span>
        </button>
        <button class="quick-action-btn" id="quick-zero-stock">
          <i class="fas fa-times-circle"></i>
          <span>Zero Stock</span>
        </button>
      </div>

      <!-- Filter Panel -->
      <div class="filter-panel">
        <div class="filter-title">Filter & Search</div>
        <div class="filter-row">
          <div class="filter-group">
            <label class="filter-label">Shelf</label>
            <select id="shelf-select" class="form-control">
              <option value="ALL">-- All Shelves --</option>
              <option value="">-- choose shelf --</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Search Items</label>
            <input id="search" class="form-control" placeholder="Search item...">
          </div>
          <div class="filter-group" style="margin-top: 20px;">
            <button id="clear-filters" class="btn btn-outline btn-small">Clear Filters</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">Inventory Management</div>
        <div class="card-body">
          <div class="row" style="justify-content:space-between; align-items:center;">
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
              <div class="shelf-controls">
                <button id="add-shelf-btn" class="btn btn-primary btn-small hidden" title="Add new shelf">
                  <i class="fas fa-plus"></i> Add Shelf
                </button>
                <button id="edit-shelf-btn" class="btn btn-secondary btn-small hidden" title="Edit selected shelf">
                  <i class="fas fa-edit"></i> Edit Shelf
                </button>
                <button id="delete-shelf-btn" class="btn btn-danger btn-small hidden" title="Delete selected shelf">
                  <i class="fas fa-trash"></i> Delete Shelf
                </button>
              </div>
            </div>

            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
              <button id="sort-asc" class="btn btn-outline btn-small">
                <i class="fas fa-sort-alpha-down"></i> A-Z
              </button>
              <button id="sort-desc" class="btn btn-outline btn-small">
                <i class="fas fa-sort-alpha-down-alt"></i> Z-A
              </button>
            </div>
          </div>

          <table aria-label="Inventory Table">
            <thead>
              <tr>
                <th style="width:48px">No</th>
                <th style="text-align:left">Item Name</th>
                <th>Initial Stock</th>
                <th>In (+)</th>
                <th>Out (-)</th>
                <th>Shelf</th>
                <th>Final Stock</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="items-table"></tbody>
          </table>

          <div class="bottom-bar">
            <div class="controls-left">
              <div id="admin-controls" class="row hidden" style="margin:0;">
                <button id="import-btn" class="btn btn-primary btn-small">
                  <i class="fas fa-file-import"></i> Import Data
                </button>
                <button id="export-btn" class="btn btn-secondary btn-small">
                  <i class="fas fa-file-export"></i> Export Excel
                </button>
                <button id="delete-all-btn" class="btn btn-danger btn-small">
                  <i class="fas fa-trash-alt"></i> Delete All Items
                </button>
              </div>
            </div>

            <div class="controls-center">
              <div class="hint" style="margin:0;">
                <div class="note" style="margin:0">⚠️ Items with 1 stock remaining will be highlighted in orange and trigger email alerts to admins</div>
              </div>
            </div>

            <div class="controls-right">
              <button id="delete-account" class="btn btn-danger btn-small">
                <i class="fas fa-user-times"></i> Delete My Account
              </button>
              <button id="logout" class="btn btn-warning btn-small">
                <i class="fas fa-sign-out-alt"></i> Sign out
              </button>
              <div id="app-status" class="status" style="margin-left:8px;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Detail Panel untuk item yang diklik -->
  <div id="item-detail-panel">
    <div class="detail-header">
      <div class="detail-title">Item Details</div>
      <button class="close-detail">
        <i class="fas fa-times"></i> Close
      </button>
    </div>
    <div id="item-detail-content">
      <!-- Konten detail akan diisi oleh JavaScript -->
    </div>
  </div>

  <!-- History modal -->
  <div id="history-modal" aria-hidden="true">
    <div id="history-panel" role="dialog" aria-modal="true">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:15px;">
        <h3 id="history-title">History</h3>
        <button id="history-close" class="history-close">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
      <div id="history-controls" class="stats-controls" style="margin-bottom:15px;"></div>
      <div id="history-list" style="min-height:60px"></div>
    </div>
  </div>

  <!-- PERBAIKAN UTAMA: Modal untuk Stats -->
  <div id="stats-modal">
    <div class="stats-modal-content">
      <div class="stats-modal-header">
        <h2 class="stats-modal-title">Stock Statistics</h2>
        <button class="stats-modal-close" id="stats-modal-close">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
      <div class="stats-modal-body">
        <div class="stats-tabs">
          <button class="stats-tab active" data-tab="stock-in">Stock In</button>
          <button class="stats-tab" data-tab="stock-out">Stock Out</button>
          <button class="stats-tab" data-tab="current-stock">Current Stock</button>
        </div>
        
        <div class="stats-tab-content active" id="stock-in-tab">
          <div class="chart-header-actions">
            <button class="chart-open-btn" data-chart-type="stock-in">
              <i class="fas fa-expand"></i> Open Full View
            </button>
          </div>
          <div class="vertical-chart-container">
            <div class="vertical-chart-wrapper">
              <canvas id="stock-in-chart" class="vertical-chart-canvas"></canvas>
            </div>
            <div class="scroll-indicator">← Scroll →</div>
          </div>
        </div>
        
        <div class="stats-tab-content" id="stock-out-tab">
          <div class="chart-header-actions">
            <button class="chart-open-btn" data-chart-type="stock-out">
              <i class="fas fa-expand"></i> Open Full View
            </button>
          </div>
          <div class="vertical-chart-container">
            <div class="vertical-chart-wrapper">
              <canvas id="stock-out-chart" class="vertical-chart-canvas"></canvas>
            </div>
            <div class="scroll-indicator">← Scroll →</div>
          </div>
        </div>
        
        <div class="stats-tab-content" id="current-stock-tab">
          <div class="chart-header-actions">
            <button class="chart-open-btn" data-chart-type="current-stock">
              <i class="fas fa-expand"></i> Open Full View
            </button>
          </div>
          <div class="vertical-chart-container">
            <div class="vertical-chart-wrapper">
              <canvas id="current-stock-chart" class="vertical-chart-canvas"></canvas>
            </div>
            <div class="scroll-indicator">← Scroll →</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyDohNEc6SE6F_YKRBQ5E4iV1ZTjAoZquqg",
  authDomain: "stock-counttt.firebaseapp.com",
  databaseURL: "https://stock-counttt-default-rtdb.firebaseio.com",
  projectId: "stock-counttt",
  storageBucket: "stock-counttt.firebasestorage.app",
  messagingSenderId: "902468240503",
  appId: "1:902468240503:web:acd2c6371d764d27e2f272",
  measurementId: "G-LBP7N097XT"
};

// Elastic Email Configuration
const ELASTIC_EMAIL_CONFIG = {
  apiKey: '93635A2E4397A961B7B29AE0C5E5FAE7087857BF4B89B83231CA30E68EE829B62DA7E14900410A3C9EAE15B09C4A57D2',
  fromEmail: 'helpdesk.kpc@gmail.com',
  fromName: 'Stock Count'
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// DOM Elements
const authSection = document.getElementById('auth-section');
const appSection = document.getElementById('app-section');
const emailInput = document.getElementById('email');
const passwordInput = document.getElementById('password');
const adminCodeInput = document.getElementById('admin-code');
const signupBtn = document.getElementById('signup');
const loginBtn = document.getElementById('login');
const logoutBtn = document.getElementById('logout');
const authStatus = document.getElementById('auth-status');
const passwordToggle = document.getElementById('password-toggle');

const logoWrap = document.getElementById('logo-wrap');
const appLogo = document.getElementById('app-logo');
const logoFile = document.getElementById('logo-file');

const shelfSelect = document.getElementById('shelf-select');
const addShelfBtn = document.getElementById('add-shelf-btn');
const editShelfBtn = document.getElementById('edit-shelf-btn');
const deleteShelfBtn = document.getElementById('delete-shelf-btn');

const searchInput = document.getElementById('search');
const sortAscBtn = document.getElementById('sort-asc');
const sortDescBtn = document.getElementById('sort-desc');

const itemsTable = document.getElementById('items-table');
const adminControls = document.getElementById('admin-controls');
const importBtn = document.getElementById('import-btn');
const exportBtn = document.getElementById('export-btn');
const deleteAllBtn = document.getElementById('delete-all-btn');
const deleteAccountBtn = document.getElementById('delete-account');
const appStatus = document.getElementById('app-status');

const historyModal = document.getElementById('history-modal');
const historyCloseBtn = document.getElementById('history-close');
const historyList = document.getElementById('history-list');
const historyTitle = document.getElementById('history-title');
const historyControls = document.getElementById('history-controls');

const itemDetailPanel = document.getElementById('item-detail-panel');
const itemDetailContent = document.getElementById('item-detail-content');
const closeDetailBtn = document.querySelector('.close-detail');

// Stats modal elements
const statsModal = document.getElementById('stats-modal');
const statsModalClose = document.getElementById('stats-modal-close');

// Dashboard Elements
const totalItemsEl = document.getElementById('total-items');
const lowStockItemsEl = document.getElementById('low-stock-items');
const outOfStockEl = document.getElementById('out-of-stock');
const totalShelvesEl = document.getElementById('total-shelves');

// Quick Action Elements
const quickAddItemBtn = document.getElementById('quick-add-item');
const quickViewStatsBtn = document.getElementById('quick-view-stats');
const quickLowStockBtn = document.getElementById('quick-low-stock');
const quickZeroStockBtn = document.getElementById('quick-zero-stock');

// Filter Elements
const clearFiltersBtn = document.getElementById('clear-filters');

// User role badge
const userRoleBadge = document.getElementById('user-role-badge');

// Global Variables
let currentUser = null;
let currentUserRole = 'user';
let itemsData = [];
let shelves = [];
let selectedShelfId = 'ALL';
let itemsRefListener = null;
let currentHistoryContext = { shelfKey: null, itemKey: null, itemName: null };
let selectedItem = null;

const SAFETY_STOCK_MIN = 1;
const LOW_STOCK_THRESHOLD = 1;
const EMAIL_COOLDOWN_MINUTES = 30;

// Chart instances
let stockInChart = null;
let stockOutChart = null;
let currentStockChart = null;

// PERBAIKAN: Variabel untuk menyimpan state filter
let currentSearchTerm = '';
let currentSortOrder = 'asc';

/* Password Toggle */
passwordToggle.addEventListener('click', function() {
  const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
  passwordInput.setAttribute('type', type);
  const icon = this.querySelector('i');
  if (type === 'password') {
    icon.className = 'fas fa-eye';
  } else {
    icon.className = 'fas fa-eye-slash';
  }
});

/* AUTH state */
auth.onAuthStateChanged(async user => {
  if (user) {
    currentUser = user;
    try {
      const snap = await db.ref('users/' + user.uid + '/role').once('value');
      currentUserRole = snap.val() || 'user';
      userRoleBadge.textContent = currentUserRole;
      userRoleBadge.classList.remove('hidden');
    } catch (e) {
      currentUserRole = 'user';
    }
    showApp();
  } else {
    authSection.style.display = 'block';
    appSection.classList.add('hidden');
    logoWrap.style.display = 'none';
    userRoleBadge.classList.add('hidden');
  }
});

/* Signup / Login / Logout */
signupBtn.addEventListener('click', async () => {
  const email = emailInput.value.trim();
  const pass = passwordInput.value;
  if(!email || !pass){ 
    authStatus.style.color='red'; 
    authStatus.textContent='Email & password required'; 
    return; 
  }
  const code = adminCodeInput.value.trim();
  const role = (code === 'ADMIN123') ? 'admin' : 'user';
  try {
    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    await db.ref('users/' + cred.user.uid).set({ email, role });
    authStatus.style.color='green'; 
    authStatus.textContent='Sign up success. Please sign in.';
  } catch (err) {
    authStatus.style.color='red'; 
    authStatus.textContent = err.message;
  }
});

loginBtn.addEventListener('click', async () => {
  const email = emailInput.value.trim();
  const pass = passwordInput.value;
  if(!email || !pass){ 
    authStatus.style.color='red'; 
    authStatus.textContent='Email & password required'; 
    return; 
  }
  try {
    await auth.signInWithEmailAndPassword(email, pass);
    const snap = await db.ref('users/' + currentUser.uid + '/role').once('value');
    currentUserRole = snap.val() || 'user';
    userRoleBadge.textContent = currentUserRole;
  } catch (err) {
    authStatus.style.color='red'; 
    authStatus.textContent = err.message;
  }
});

logoutBtn.addEventListener('click', () => auth.signOut().then(() => location.reload()));

function showApp(){
  authSection.style.display = 'none';
  appSection.classList.remove('hidden');
  logoWrap.style.display = 'block';
  adminControls.classList.toggle('hidden', currentUserRole !== 'admin');
  addShelfBtn.classList.toggle('hidden', currentUserRole !== 'admin');
  editShelfBtn.classList.toggle('hidden', currentUserRole !== 'admin');
  deleteShelfBtn.classList.toggle('hidden', currentUserRole !== 'admin');
  setupLogoRealtime();
  setupLogoUploadUI();
  loadShelvesRealtime();
}

/* Logo */
function setupLogoRealtime(){
  db.ref('app/assets/logoBase64').on('value', snap => {
    const dataUrl = snap.val();
    appLogo.src = dataUrl || '';
  });
}

function setupLogoUploadUI(){
  appLogo.onclick = null;
  logoFile.onchange = null;
  if(currentUserRole === 'admin'){
    appLogo.addEventListener('click', () => logoFile.click());
    logoFile.addEventListener('change', async (ev) => {
      const file = ev.target.files[0];
      if(!file) return;
      appStatus.textContent = 'Reading file...';
      try {
        const reader = new FileReader();
        reader.onload = async (e) => {
          const dataUrl = e.target.result;
          if(!dataUrl) { 
            appStatus.textContent = 'Failed to read file.'; 
            setTimeout(() => appStatus.textContent = '', 2000); 
            return; 
          }
          await db.ref('app/assets').update({ logoBase64: dataUrl });
          appStatus.textContent = 'Logo saved.';
          setTimeout(() => appStatus.textContent = '', 2000);
        };
        reader.readAsDataURL(file);
      } catch(err) {
        appStatus.textContent = 'Logo save failed.';
        setTimeout(() => appStatus.textContent = '', 2000);
      }
    });
  }
}

/* Shelves realtime */
function loadShelvesRealtime(){
  db.ref('shelves').on('value', snap => {
    shelves = [];
    shelfSelect.innerHTML = '';
    const allOpt = document.createElement('option');
    allOpt.value = 'ALL';
    allOpt.textContent = '-- All Shelves --';
    shelfSelect.appendChild(allOpt);
    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.textContent = '-- choose shelf --';
    shelfSelect.appendChild(placeholder);

    snap.forEach(child => {
      const v = child.val() || {};
      shelves.push({ key: child.key, name: v.name || 'Untitled' });
      const opt = document.createElement('option');
      opt.value = child.key;
      opt.textContent = v.name || 'Untitled';
      shelfSelect.appendChild(opt);
    });

    totalShelvesEl.textContent = shelves.length;

    const exists = (selectedShelfId === 'ALL') ? true : shelves.find(s => s.key === selectedShelfId);
    if(!selectedShelfId || !exists){
      selectedShelfId = 'ALL';
      shelfSelect.value = 'ALL';
      startItemsListenerForSelectedShelf();
    } else {
      shelfSelect.value = selectedShelfId;
      startItemsListenerForSelectedShelf();
    }
  });
}

addShelfBtn.addEventListener('click', async () => {
  const name = prompt('New shelf name:');
  if(!name || !name.trim()) { alert('Name empty'); return; }
  try {
    const key = db.ref('shelves').push().key;
    await db.ref('shelves/' + key).set({ name: name.trim(), createdBy: currentUser?.uid || '' });
    appStatus.textContent = 'Shelf added.';
    setTimeout(() => appStatus.textContent = '', 1800);
    selectedShelfId = key;
    shelfSelect.value = key;
    startItemsListenerForSelectedShelf();
  } catch(err) {
    appStatus.textContent = 'Add shelf failed: ' + (err.message || err);
  }
});

editShelfBtn.addEventListener('click', async () => {
  if(!selectedShelfId || selectedShelfId === 'ALL'){ alert('Select a single shelf first'); return; }
  const current = shelves.find(s => s.key === selectedShelfId);
  const newName = prompt('Edit shelf name:', current ? current.name : '');
  if(!newName || !newName.trim()) return;
  try {
    await db.ref('shelves/' + selectedShelfId).update({ name: newName.trim() });
    appStatus.textContent = 'Shelf renamed.';
    setTimeout(() => appStatus.textContent = '', 1800);
  } catch(err) {
    appStatus.textContent = 'Edit shelf failed: ' + (err.message || err);
  }
});

deleteShelfBtn.addEventListener('click', async () => {
  if(!selectedShelfId || selectedShelfId === 'ALL'){ alert('Select a single shelf first'); return; }
  if(!confirm('Delete this shelf and all items inside? This cannot be undone.')) return;
  try {
    await db.ref('shelves/' + selectedShelfId).remove();
    await db.ref('items/' + selectedShelfId).remove();
    appStatus.textContent = 'Shelf and its items deleted.';
    selectedShelfId = 'ALL';
    shelfSelect.value = 'ALL';
    stopItemsListener();
    itemsData = [];
    renderItems();
    setTimeout(() => appStatus.textContent = '', 2000);
  } catch(err) {
    appStatus.textContent = 'Delete shelf failed: ' + (err.message || err);
  }
});

shelfSelect.addEventListener('change', () => {
  selectedShelfId = shelfSelect.value || '';
  if(!selectedShelfId){
    stopItemsListener();
    itemsData = [];
    renderItems();
    appStatus.textContent = 'No shelf selected.';
    setTimeout(() => appStatus.textContent = '', 1500);
    return;
  }
  startItemsListenerForSelectedShelf();
});

/* Items listener */
function startItemsListenerForSelectedShelf(){
  stopItemsListener();
  if(!selectedShelfId) return;

  if(selectedShelfId === 'ALL'){
    itemsRefListener = db.ref('items');
    itemsRefListener.on('value', snap => {
      itemsData = [];
      snap.forEach(shelfChild => {
        const shelfKey = shelfChild.key;
        const shelfName = shelves.find(s => s.key === shelfKey)?.name || '';
        shelfChild.forEach(child => {
          const v = child.val() || {};
          itemsData.push({
            key: child.key,
            name: v.name || '',
            initialStock: Number(v.initialStock || 0),
            stockIn: Number(v.stockIn || 0),
            stockOut: Number(v.stockOut || 0),
            finalStock: Number(v.finalStock || 0),
            shelfKey: shelfKey,
            shelf: v.shelf || shelfName
          });
        });
      });
      updateDashboardStats();
      renderItems();
    });
    return;
  }

  itemsRefListener = db.ref('items/' + selectedShelfId);
  itemsRefListener.on('value', snap => {
    itemsData = [];
    snap.forEach(child => {
      const v = child.val() || {};
      itemsData.push({
        key: child.key,
        name: v.name || '',
        initialStock: Number(v.initialStock || 0),
        stockIn: Number(v.stockIn || 0),
        stockOut: Number(v.stockOut || 0),
        finalStock: Number(v.finalStock || 0),
        shelfKey: selectedShelfId,
        shelf: v.shelf || (shelves.find(s => s.key === selectedShelfId)?.name || '')
      });
    });
    updateDashboardStats();
    renderItems();
  });
}

// Update Dashboard Statistics
function updateDashboardStats() {
  const totalItems = itemsData.length;
  const lowStockItems = itemsData.filter(item => item.finalStock <= LOW_STOCK_THRESHOLD && item.finalStock > 0).length;
  const outOfStockItems = itemsData.filter(item => item.finalStock <= 0).length;
  
  totalItemsEl.textContent = totalItems;
  lowStockItemsEl.textContent = lowStockItems;
  outOfStockEl.textContent = outOfStockItems;
}

function stopItemsListener(){
  try {
    if(itemsRefListener && itemsRefListener.off) itemsRefListener.off();
    itemsRefListener = null;
  } catch(e){ /* ignore */ }
}

// Fungsi untuk menampilkan detail item
function showItemDetail(item) {
  selectedItem = item;
  
  itemDetailContent.innerHTML = `
    <div class="detail-section">
      <div class="detail-label">Item Name</div>
      <div class="detail-value">${escapeHtml(item.name || '')}</div>
    </div>
    
    <div class="detail-section">
      <div class="detail-label">Shelf</div>
      <div class="detail-value">${escapeHtml(item.shelf || '')}</div>
    </div>
    
    <div class="detail-section">
      <div class="detail-label">Initial Stock</div>
      <div class="detail-value">${item.initialStock || 0}</div>
    </div>
    
    <div class="detail-section">
      <div class="detail-label">Current Stock</div>
      <div class="detail-value">
        <span class="badge ${getStockBadgeClass(item.finalStock)}">${item.finalStock || 0}</span>
        ${item.finalStock <= LOW_STOCK_THRESHOLD ? '<div class="stock-warning" style="margin-top:8px;">⚠️ LOW STOCK - NEED TO RESTOCK</div>' : ''}
      </div>
    </div>
    
    <div class="detail-section">
      <div class="detail-label">Stock Movement</div>
      <div class="detail-value">
        <div style="display: flex; gap: 15px; margin-top: 10px;">
          <div style="text-align: center;">
            <div style="font-size: 12px; color: #666;">Stock In</div>
            <div style="font-size: 18px; font-weight: bold; color: #2e7d32;">+${item.stockIn || 0}</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 12px; color: #666;">Stock Out</div>
            <div style="font-size: 18px; font-weight: bold; color: #d32f2f;">-${item.stockOut || 0}</div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="detail-actions">
      <button class="btn btn-primary btn-small" onclick="showHistory('${item.shelfKey || selectedShelfId}', '${item.key}', '${escapeHtml(item.name || '')}')">
        <i class="fas fa-history"></i> View History
      </button>
      ${currentUserRole === 'admin' ? `
        <button class="btn btn-secondary btn-small" onclick="editItemName('${item.key}', '${escapeHtml(item.name || '')}', '${item.shelfKey || selectedShelfId}')">
          <i class="fas fa-edit"></i> Edit
        </button>
        <button class="btn btn-danger btn-small" onclick="deleteItem('${item.key}', '${item.shelfKey || selectedShelfId}')">
          <i class="fas fa-trash"></i> Delete
        </button>
      ` : ''}
    </div>
  `;
  
  itemDetailPanel.classList.add('open');
}

// Fungsi untuk mendapatkan class badge berdasarkan stok
function getStockBadgeClass(stock) {
  if (stock <= 0) return 'badge-low';
  if (stock <= LOW_STOCK_THRESHOLD) return 'badge-warning';
  return 'badge-ok';
}

// Fungsi untuk menutup detail panel
function closeItemDetail() {
  itemDetailPanel.classList.remove('open');
  selectedItem = null;
  document.querySelectorAll('.clickable-row.active').forEach(row => {
    row.classList.remove('active');
  });
}

closeDetailBtn.addEventListener('click', closeItemDetail);

// PERBAIKAN UTAMA: Fungsi renderItems yang sudah diperbaiki
function renderItems(){
  let filtered = [...itemsData];
  
  // Apply search filter
  if (currentSearchTerm) {
    filtered = filtered.filter(i => (i.name || '').toLowerCase().includes(currentSearchTerm));
  }
  
  // Apply sort
  if (currentSortOrder === 'asc') {
    filtered.sort((a,b) => (a.name||'').localeCompare(b.name||''));
  } else {
    filtered.sort((a,b) => (b.name||'').localeCompare(a.name||''));
  }
  
  itemsTable.innerHTML = '';
  
  filtered.forEach((item, idx) => {
    const tr = document.createElement('tr');
    tr.className = 'clickable-row';
    if (item.finalStock <= LOW_STOCK_THRESHOLD) {
      tr.classList.add('low-stock-row');
    }
    
    tr.addEventListener('click', (e) => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') return;
      document.querySelectorAll('.clickable-row.active').forEach(row => row.classList.remove('active'));
      tr.classList.add('active');
      showItemDetail(item);
    });

    const tdNo = document.createElement('td'); 
    tdNo.textContent = idx + 1;
    
    const tdName = document.createElement('td'); 
    tdName.textContent = item.name || ''; 
    tdName.style.textAlign = 'left';
    
    if (item.finalStock <= LOW_STOCK_THRESHOLD) {
      const warningText = document.createElement('div');
      warningText.className = 'stock-warning';
      warningText.textContent = '⚠️ LOW STOCK - NEED TO RESTOCK';
      tdName.appendChild(warningText);
    }

    const tdInitial = document.createElement('td'); 
    tdInitial.textContent = item.initialStock || 0;

    const tdIn = document.createElement('td');
    const inInput = document.createElement('input'); 
    inInput.type = 'number'; 
    inInput.min = 0; 
    inInput.value = 0;
    inInput.className = 'num-input';
    tdIn.appendChild(inInput);

    const tdOut = document.createElement('td');
    const outInput = document.createElement('input'); 
    outInput.type = 'number'; 
    outInput.min = 0; 
    outInput.value = 0;
    outInput.className = 'num-input';
    tdOut.appendChild(outInput);

    const tdShelf = document.createElement('td'); 
    tdShelf.className = 'col-shelf';
    tdShelf.textContent = item.shelf || '—';

    const tdFinal = document.createElement('td');
    const finalBadge = document.createElement('span'); 
    finalBadge.className = 'badge';
    const orderFlag = document.createElement('span'); 
    
    if (item.finalStock <= 0) {
      finalBadge.className = 'badge badge-low';
      orderFlag.className = 'order-flag'; 
      orderFlag.textContent = 'OUT OF STOCK';
    } else if (item.finalStock <= LOW_STOCK_THRESHOLD) {
      finalBadge.className = 'badge badge-warning';
      orderFlag.className = 'warning-flag'; 
      orderFlag.textContent = 'LOW STOCK';
    } else {
      finalBadge.className = 'badge badge-ok';
      orderFlag.className = 'order-flag'; 
      orderFlag.textContent = '';
    }
    
    finalBadge.textContent = item.finalStock || 0;
    tdFinal.appendChild(finalBadge);
    tdFinal.appendChild(orderFlag);

    const tdAction = document.createElement('td'); 
    tdAction.className = 'row-actions';

    // History button
    const historyBtn = document.createElement('button');
    historyBtn.innerHTML = '<i class="fas fa-history"></i>';
    historyBtn.className = 'btn btn-primary btn-small';
    historyBtn.title = 'Show history for this item';
    historyBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      showHistory(item.shelfKey || selectedShelfId, item.key, item.name);
    });
    tdAction.appendChild(historyBtn);

    // Apply button
    const applyBtn = document.createElement('button');
    applyBtn.innerHTML = '<i class="fas fa-check"></i>';
    applyBtn.className = 'btn btn-secondary btn-small';
    applyBtn.title = 'Apply changes';
    applyBtn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const inVal = parseInt(inInput.value || 0, 10) || 0;
      const outVal = parseInt(outInput.value || 0, 10) || 0;
      const targetShelfKey = item.shelfKey || selectedShelfId;

      if (inVal === 0 && outVal === 0) {
        appStatus.textContent = 'No changes to apply';
        setTimeout(() => appStatus.textContent = '', 1400);
        return;
      }

      try {
        const newFinal = Math.max(0, (Number(item.finalStock || 0) + inVal - outVal));
        
        // PERBAIKAN: Update item dengan benar
        await db.ref('items/' + targetShelfKey + '/' + item.key).update({
          stockIn: inVal,
          stockOut: outVal,
          finalStock: newFinal
        });

        // PERBAIKAN UTAMA: Panggil fungsi email dengan cooldown 30 menit
        if (newFinal <= LOW_STOCK_THRESHOLD) {
          await sendLowStockEmailWithCooldown(item.name, newFinal, targetShelfKey, item.key);
        }

        const historyData = {
          type: 'apply',
          itemName: item.name,
          stockIn: inVal,
          stockOut: outVal,
          initialStock: item.initialStock,
          finalStockBefore: item.finalStock,
          finalStockAfter: newFinal,
          userId: currentUser?.uid || '',
          userEmail: currentUser?.email || '',
          timestamp: Date.now(),
          month: new Date().getMonth() + 1,
          year: new Date().getFullYear()
        };

        const historyRef = db.ref('history/' + targetShelfKey + '/' + item.key).push();
        await historyRef.set(historyData);

        // PERBAIKAN UTAMA: Reset input fields setelah apply berhasil
        inInput.value = 0;
        outInput.value = 0;
        
        // PERBAIKAN: Data akan diupdate otomatis oleh realtime listener
        appStatus.textContent = 'Apply completed - History added';
        if (newFinal <= LOW_STOCK_THRESHOLD) {
          appStatus.textContent += ' - Low stock alert sent';
        }
        setTimeout(() => appStatus.textContent = '', 1400);

      } catch(err) {
        console.error('Apply error:', err);
        appStatus.textContent = 'Apply failed: ' + err.message;
        setTimeout(() => appStatus.textContent = '', 2000);
      }
    });

    if(currentUserRole === 'admin'){
      const editBtn = document.createElement('button'); 
      editBtn.innerHTML = '<i class="fas fa-edit"></i>';
      editBtn.className = 'btn btn-secondary btn-small';
      editBtn.title = 'Edit item';
      editBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        editItemName(item.key, item.name, item.shelfKey);
      });
      const deleteBtn = document.createElement('button'); 
      deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
      deleteBtn.className = 'btn btn-danger btn-small';
      deleteBtn.title = 'Delete item';
      deleteBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        deleteItem(item.key, item.shelfKey);
      });
      tdAction.appendChild(editBtn); 
      tdAction.appendChild(deleteBtn);
    }

    inInput.addEventListener('input', () => computePreview(item, inInput, outInput, finalBadge, orderFlag));
    outInput.addEventListener('input', () => computePreview(item, inInput, outInput, finalBadge, orderFlag));

    tdAction.appendChild(applyBtn);

    tr.appendChild(tdNo);
    tr.appendChild(tdName);
    tr.appendChild(tdInitial);
    tr.appendChild(tdIn);
    tr.appendChild(tdOut);
    tr.appendChild(tdShelf);
    tr.appendChild(tdFinal);
    tr.appendChild(tdAction);
    itemsTable.appendChild(tr);
  });
}

// Compute preview for real-time calculation
function computePreview(item, inInput, outInput, finalBadge, orderFlag) {
  const inVal = parseInt(inInput.value || 0, 10) || 0;
  const outVal = parseInt(outInput.value || 0, 10) || 0;
  const computed = Math.max(0, (Number(item.finalStock || 0) + inVal - outVal));
  
  finalBadge.textContent = computed;
  
  if (computed <= 0) {
    finalBadge.className = 'badge badge-low';
    orderFlag.className = 'order-flag'; 
    orderFlag.textContent = 'OUT OF STOCK';
  } else if (computed <= LOW_STOCK_THRESHOLD) {
    finalBadge.className = 'badge badge-warning';
    orderFlag.className = 'warning-flag'; 
    orderFlag.textContent = 'LOW STOCK';
  } else {
    finalBadge.className = 'badge badge-ok';
    orderFlag.className = 'order-flag'; 
    orderFlag.textContent = '';
  }
}

/* PERBAIKAN UTAMA: Low Stock Email Alert dengan Elastic Email */
async function sendLowStockEmailWithCooldown(itemName, currentStock, shelfKey, itemKey) {
  console.log('🔔 DEBUG: Low stock function TRIGGERED!', {
    itemName, 
    currentStock, 
    shelfKey, 
    itemKey,
    time: new Date().toLocaleString()
  });

  try {
    // Cek cooldown
    const emailAlertsRef = db.ref('lowStockAlerts');
    const snapshot = await emailAlertsRef
      .orderByChild('itemKey')
      .equalTo(itemKey)
      .once('value');
    
    let shouldSendEmail = true;
    const now = Date.now();
    const cooldownMs = EMAIL_COOLDOWN_MINUTES * 60 * 1000;
    
    snapshot.forEach(child => {
      const alert = child.val();
      const timeDiff = now - (alert.timestamp || 0);
      if (timeDiff < cooldownMs) {
        shouldSendEmail = false;
      }
    });
    
    if (!shouldSendEmail) {
      console.log('⏸️ DEBUG: Email SKIPPED - cooldown active');
      return;
    }
    
    // Get warehouse emails
    const warehouseSnapshot = await db.ref('warehouseTeam').once('value');
    const warehouseEmails = [];
    
    warehouseSnapshot.forEach(child => {
      const member = child.val();
      if (member.email && member.active) {
        warehouseEmails.push(member.email);
      }
    });

    // Fallback to admins if no warehouse team
    if (warehouseEmails.length === 0) {
      const adminSnapshot = await db.ref('users').orderByChild('role').equalTo('admin').once('value');
      adminSnapshot.forEach(child => {
        const admin = child.val();
        if (admin.email) {
          warehouseEmails.push(admin.email);
        }
      });
    }

    if (warehouseEmails.length === 0) {
      console.log('❌ DEBUG: NO RECIPIENT EMAILS FOUND! Email cannot be sent.');
      return;
    }

    // Kirim email menggunakan Elastic Email
    const emailSent = await sendElasticEmail(itemName, currentStock, shelfKey, warehouseEmails);
    
    if (emailSent) {
      console.log('✅✅✅ DEBUG: EMAIL SENT SUCCESSFULLY!');
      
      // Save to Firebase untuk record keeping
      const alertRef = db.ref('lowStockAlerts').push();
      await alertRef.set({
        itemName: itemName,
        currentStock: currentStock,
        shelfKey: shelfKey,
        itemKey: itemKey,
        recipientEmails: warehouseEmails,
        timestamp: Date.now(),
        alertSent: true,
        cooldownMinutes: EMAIL_COOLDOWN_MINUTES
      });
    } else {
      console.log('❌❌❌ DEBUG: EMAIL FAILED TO SEND!');
    }

  } catch(err) {
    console.error('💥 DEBUG: ERROR in sendLowStockEmailWithCooldown:', err);
    
    // Save error to Firebase for debugging
    const errorRef = db.ref('emailErrors').push();
    await errorRef.set({
      itemName: itemName,
      currentStock: currentStock,
      shelfKey: shelfKey,
      itemKey: itemKey,
      timestamp: Date.now(),
      error: err.message,
      stack: err.stack
    });
  }
}

async function sendElasticEmail(itemName, currentStock, shelfKey, recipientEmails) {
  console.log('📨 DEBUG: Starting Elastic Email send process...');
  
  try {
    // Filter hanya email yang valid
    const validEmails = recipientEmails.filter(email => 
      email && email.trim() !== '' && email.includes('@')
    );
    
    console.log('🎯 DEBUG: Valid recipients:', validEmails);
    
    if (validEmails.length === 0) {
      console.log('❌ DEBUG: No valid recipients found');
      return false;
    }

    // Kirim ke setiap email secara terpisah
    const results = [];
    
    for (const singleEmail of validEmails) {
      console.log(`📧 DEBUG: Sending to: ${singleEmail}`);
      
      const success = await sendSingleEmail(itemName, currentStock, shelfKey, singleEmail);
      results.push({ email: singleEmail, success });
      
      // Jeda 1 detik antara setiap email untuk menghindari rate limit
      await new Promise(resolve => setTimeout(resolve, 1000));
    }

    const successfulSends = results.filter(r => r.success).length;
    console.log(`✅ DEBUG: Successfully sent ${successfulSends} out of ${validEmails.length} emails`);
    
    return successfulSends > 0;
    
  } catch (error) {
    console.error('💥💥💥 DEBUG: ERROR SENDING EMAILS:', error);
    return false;
  }
}

/* FUNGSI BARU: Kirim ke satu email saja */
async function sendSingleEmail(itemName, currentStock, shelfKey, singleEmail) {
  try {
    // Prepare email content
    const subject = currentStock <= 0 
      ? `🚨 STOCK HABIS: ${itemName} - Sisa 0` 
      : `🚨 STOCK HAMPIR HABIS: ${itemName} - Sisa ${currentStock}`;
    
    console.log('📝 DEBUG: Email subject:', subject);
    
    const htmlContent = createEmailHTMLTemplate(itemName, currentStock, shelfKey);
    const textContent = createEmailTextTemplate(itemName, currentStock, shelfKey);
    
    // Prepare form data untuk Elastic Email API - SATU EMAIL SAJA
    const formData = new FormData();
    formData.append('apikey', ELASTIC_EMAIL_CONFIG.apiKey);
    formData.append('from', ELASTIC_EMAIL_CONFIG.fromEmail);
    formData.append('fromName', ELASTIC_EMAIL_CONFIG.fromName);
    formData.append('to', singleEmail); // ← HANYA SATU EMAIL
    formData.append('subject', subject);
    formData.append('bodyHtml', htmlContent);
    formData.append('bodyText', textContent);
    
    console.log('🌐 DEBUG: Sending request to Elastic Email API...');
    
    // Kirim request ke Elastic Email API
    const response = await fetch('https://api.elasticemail.com/v2/email/send', {
      method: 'POST',
      body: formData
    });
    
    console.log('📡 DEBUG: API Response status:', response.status);
    
    const result = await response.json();
    console.log('📊 DEBUG: Elastic Email API response for', singleEmail, ':', result);
    
    if (result.success) {
      console.log(`✅✅✅ DEBUG: EMAIL SENT SUCCESSFULLY TO: ${singleEmail}`);
      console.log('📨 DEBUG: Transaction ID:', result.data?.TransactionID);
      return true;
    } else {
      console.error(`❌❌❌ DEBUG: FAILED TO SEND TO ${singleEmail}:`, result);
      return false;
    }
  } catch (error) {
    console.error(`💥 DEBUG: ERROR SENDING TO ${singleEmail}:`, error);
    return false;
  }
}

/* PERBAIKAN UTAMA: Fungsi untuk membuat HTML email template */
function createEmailHTMLTemplate(itemName, currentStock, shelfKey) {
  const urgencyLevel = currentStock <= 0 ? 'HIGH' : 'MEDIUM';
  const urgencyColor = currentStock <= 0 ? '#d32f2f' : '#ff9800';
  const statusText = currentStock <= 0 ? 'OUT OF STOCK' : 'LOW STOCK';
  
  return `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
    .container { max-width: 600px; margin: 0 auto; padding: 20px; }
    .header { background: linear-gradient(135deg, #d35400, #a04000); color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0; }
    .content { background: #f9f9f9; padding: 20px; border-radius: 0 0 8px 8px; }
    .alert-badge { background: ${urgencyColor}; color: white; padding: 8px 16px; border-radius: 20px; font-weight: bold; display: inline-block; margin-bottom: 15px; }
    .item-details { background: white; padding: 15px; border-radius: 6px; margin: 15px 0; border-left: 4px solid ${urgencyColor}; }
    .footer { text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 12px; }
    .stock-number { font-size: 24px; font-weight: bold; color: ${urgencyColor}; margin: 10px 0; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>🚨 STOCK ALERT</h1>
      <p>Inventory Management System</p>
    </div>
    
    <div class="content">
      <div class="alert-badge">${statusText} - ${urgencyLevel} PRIORITY</div>
      
      <h2>Item Details:</h2>
      <div class="item-details">
        <p><strong>Item Name:</strong> ${escapeHtml(itemName)}</p>
        <p><strong>Current Stock:</strong></p>
        <div class="stock-number">${currentStock}</div>
        <p><strong>Shelf Location:</strong> ${escapeHtml(shelfKey)}</p>
        <p><strong>Alert Time:</strong> ${new Date().toLocaleString()}</p>
      </div>
      
      <div style="background: #fff3e0; padding: 15px; border-radius: 6px; margin: 15px 0;">
        <h3 style="color: #e65100; margin-top: 0;">⚠️ Action Required:</h3>
        <p>Please restock this item immediately to avoid stockout.</p>
        <p><strong>Recommended Action:</strong> Order new stock and update inventory system.</p>
      </div>
      
      <p>This alert was automatically generated by the Stock Count System.</p>
    </div>
    
    <div class="footer">
      <p>&copy; ${new Date().getFullYear()} Stock Count System. All rights reserved.</p>
      <p>This is an automated message. Please do not reply to this email.</p>
    </div>
  </div>
</body>
</html>
  `;
}

/* PERBAIKAN UTAMA: Fungsi untuk membuat plain text email template */
function createEmailTextTemplate(itemName, currentStock, shelfKey) {
  const statusText = currentStock <= 0 ? 'OUT OF STOCK' : 'LOW STOCK';
  
  return `
STOCK ALERT - Inventory Management System

${statusText} ALERT

Item Details:
- Item Name: ${itemName}
- Current Stock: ${currentStock}
- Shelf Location: ${shelfKey}
- Alert Time: ${new Date().toLocaleString()}

ACTION REQUIRED:
Please restock this item immediately to avoid stockout.

Recommended Action: Order new stock and update inventory system.

This alert was automatically generated by the Stock Count System.

© ${new Date().getFullYear()} Stock Count System. All rights reserved.
This is an automated message. Please do not reply to this email.
  `;
}

/* PERBAIKAN: Export History tanpa perhitungan */
async function exportHistoryToExcel(shelfKey, itemKey, itemName) {
  if (!shelfKey || !itemKey) {
    appStatus.textContent = 'No target for history export';
    setTimeout(() => appStatus.textContent = '', 2000);
    return;
  }

  try {
    const snap = await db.ref('history/' + shelfKey + '/' + itemKey).once('value');
    const rows = [];
    
    snap.forEach(child => {
      const v = child.val() || {};
      const dt = v.timestamp ? (new Date(v.timestamp)).toLocaleString() : 'Unknown date';
      const type = v.type || 'transaction';
      
      // Hanya ambil data yang diperlukan, tanpa perhitungan
      rows.push({
        Date: dt,
        Type: type,
        'Item Name': v.itemName || '',
        'User': v.userEmail || v.userId || 'Unknown',
        'Description': `Stock movement for ${v.itemName || ''}`
      });
    });
    
    rows.sort((a, b) => new Date(b.Date) - new Date(a.Date));
    
    if (!rows.length) {
      appStatus.textContent = 'No history data to export';
      setTimeout(() => appStatus.textContent = '', 2000);
      return;
    }
    
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'History');
    
    const safeName = (itemName || 'item').replace(/[^a-z0-9_\-]/ig, '_');
    XLSX.writeFile(wb, `history_${safeName}.xlsx`);
    
    appStatus.textContent = 'History exported successfully';
    setTimeout(() => appStatus.textContent = '', 2000);
    
  } catch (err) {
    console.error('Export history error:', err);
    appStatus.textContent = 'Export failed: ' + err.message;
    setTimeout(() => appStatus.textContent = '', 3000);
  }
}

/* PERBAIKAN: Modifikasi fungsi showHistory untuk menambahkan tombol export */
async function showHistory(shelfKey, itemKey, itemName) {
  if (!shelfKey || !itemKey) return alert('No target for history');
  
  currentHistoryContext = { shelfKey, itemKey, itemName };
  
  historyTitle.textContent = `History — ${itemName || ''}`;
  historyList.innerHTML = '<div style="color:#666; text-align:center; padding:20px;">Loading history…</div>';
  historyModal.style.display = 'flex';
  historyModal.setAttribute('aria-hidden', 'false');

  try {
    const snap = await db.ref('history/' + shelfKey + '/' + itemKey).once('value');
    const rows = [];
    
    snap.forEach(child => {
      const v = child.val() || {};
      rows.push({ 
        key: child.key, 
        v: v,
        timestamp: v.timestamp || 0
      });
    });
    
    rows.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
    
    // PERBAIKAN: Update history controls dengan tombol export
    historyControls.innerHTML = '';
    
    // Tombol Export History
    const exportBtn = document.createElement('button');
    exportBtn.innerHTML = '<i class="fas fa-file-export"></i> Export History';
    exportBtn.className = 'export-history-btn btn btn-secondary btn-small';
    exportBtn.title = 'Export history to Excel (without calculations)';
    exportBtn.addEventListener('click', () => exportHistoryToExcel(shelfKey, itemKey, itemName));
    historyControls.appendChild(exportBtn);
    
    // Tombol Reset History (hanya untuk admin)
    if (currentUserRole === 'admin' && rows.length > 0) {
      const resetBtn = document.createElement('button');
      resetBtn.innerHTML = '<i class="fas fa-trash"></i> Reset All History';
      resetBtn.className = 'reset-history-btn btn btn-danger btn-small';
      resetBtn.title = 'Delete all history for this item';
      resetBtn.addEventListener('click', () => resetItemHistory(shelfKey, itemKey, itemName));
      historyControls.appendChild(resetBtn);
    }
    
    if (!rows.length) {
      historyList.innerHTML = '<div class="hint" style="padding:20px; text-align:center;">No history found for this item.</div>';
      return;
    }
    
    historyList.innerHTML = '';
    rows.forEach(r => {
      const v = r.v || {};
      const dt = v.timestamp ? (new Date(v.timestamp)).toLocaleString() : 'Unknown date';
      const type = v.type || 'transaction';
      
      const content = document.createElement('div');
      content.className = 'history-item';
      
      const header = document.createElement('div');
      header.className = 'history-header';
      
      const typeBadge = document.createElement('span');
      typeBadge.className = 'history-type';
      typeBadge.textContent = type;
      
      const date = document.createElement('span');
      date.className = 'history-date';
      date.textContent = dt;
      
      header.appendChild(typeBadge);
      header.appendChild(date);
      
      const details = document.createElement('div');
      details.className = 'history-details';
      
      if (type === 'apply') {
        details.innerHTML = `
          <div class="history-detail-item">
            <span class="history-detail-label">Stock In</span>
            <span class="history-detail-value">+${Number(v.stockIn || 0)}</span>
          </div>
          <div class="history-detail-item">
            <span class="history-detail-label">Stock Out</span>
            <span class="history-detail-value">-${Number(v.stockOut || 0)}</span>
          </div>
          <div class="history-detail-item">
            <span class="history-detail-label">Initial Stock</span>
            <span class="history-detail-value">${Number(v.initialStock || 0)}</span>
          </div>
          <div class="history-detail-item">
            <span class="history-detail-label">Final Stock</span>
            <span class="history-detail-value">${Number(v.finalStockAfter || v.finalStock || 0)}</span>
          </div>
        `;
      } else {
        details.innerHTML = `
          <div class="history-detail-item">
            <span class="history-detail-label">Stock In</span>
            <span class="history-detail-value">+${Number(v.stockIn || 0)}</span>
          </div>
          <div class="history-detail-item">
            <span class="history-detail-label">Stock Out</span>
            <span class="history-detail-value">-${Number(v.stockOut || 0)}</span>
          </div>
          <div class="history-detail-item">
            <span class="history-detail-label">Final Stock</span>
            <span class="history-detail-value">${Number(v.finalStock || 0)}</span>
          </div>
        `;
      }
      
      const userInfo = document.createElement('div');
      userInfo.className = 'history-user';
      userInfo.textContent = `By: ${escapeHtml(v.userEmail || v.userId || 'Unknown user')}`;
      
      content.appendChild(header);
      content.appendChild(details);
      content.appendChild(userInfo);
      historyList.appendChild(content);
    });
  } catch (e) {
    console.error('history load error:', e);
    historyList.innerHTML = '<div style="color:red; text-align:center; padding:20px;">Failed to load history: ' + e.message + '</div>';
  }
}

/* Reset item history */
async function resetItemHistory(shelfKey, itemKey, itemName) {
  if (!confirm(`Are you sure you want to delete ALL history for "${itemName}"? This action cannot be undone.`)) {
    return;
  }

  try {
    await db.ref('history/' + shelfKey + '/' + itemKey).remove();
    appStatus.textContent = `History for "${itemName}" has been reset`;
    setTimeout(() => appStatus.textContent = '', 3000);
    showHistory(shelfKey, itemKey, itemName);
  } catch(err) {
    console.error('Reset history error:', err);
    appStatus.textContent = 'Failed to reset history: ' + err.message;
    setTimeout(() => appStatus.textContent = '', 3000);
  }
}

function closeHistory(){ 
  historyModal.style.display = 'none'; 
  historyModal.setAttribute('aria-hidden','true');
  historyControls.innerHTML = '';
}

function escapeHtml(s){ 
  return String(s||'').replace(/[&<>"']/g, c => ({
    '&':'&amp;',
    '<':'&lt;',
    '>':'&gt;',
    '"':'&quot;',
    "'":'&#39;'
  }[c])); 
}

historyCloseBtn.addEventListener('click', closeHistory);
historyModal.addEventListener('click', (e) => { 
  if(e.target === historyModal) closeHistory(); 
});

/* Add item */
async function addNewItem() {
  let targetShelfKey = selectedShelfId;
  let shelfName = shelves.find(s => s.key === targetShelfKey)?.name || '';
  if(selectedShelfId === 'ALL' || !selectedShelfId){
    const shelfNameInput = prompt('Shelf name for this item (existing or new):', '');
    if(!shelfNameInput || !shelfNameInput.trim()){ alert('Shelf name required'); return; }
    shelfName = shelfNameInput.trim();
    let shelfObj = shelves.find(s => (s.name || '').toLowerCase() === shelfName.toLowerCase());
    if(!shelfObj){
      targetShelfKey = db.ref('shelves').push().key;
      await db.ref('shelves/' + targetShelfKey).set({ name: shelfName, createdBy: currentUser?.uid || '' });
    } else {
      targetShelfKey = shelfObj.key;
    }
  }

  if(currentUserRole !== 'admin'){ alert('Only admin can add new items.'); return; }
  const name = prompt('New item name:');
  if(!name || !name.trim()) { alert('Name empty'); return; }
  const initialRaw = prompt('Initial stock (number):', '0');
  const initial = parseInt(initialRaw || 0, 10) || 0;

  try {
    const key = db.ref('items/' + targetShelfKey).push().key;
    await db.ref('items/' + targetShelfKey + '/' + key).set({
      name: name.trim(),
      initialStock: initial,
      stockIn: 0,
      stockOut: 0,
      finalStock: initial,
      shelf: shelfName,
      shelfKey: targetShelfKey
    });
    
    // PERBAIKAN: Item akan muncul otomatis karena realtime listener
    appStatus.textContent = 'Item added to shelf: ' + shelfName;
    setTimeout(() => appStatus.textContent = '', 1800);
  } catch(err){
    appStatus.textContent = 'Add item failed: ' + (err.message || err);
    setTimeout(() => appStatus.textContent = '', 2500);
  }
}

function editItemName(key, oldName, shelfKey){
  const targetShelf = shelfKey || selectedShelfId;
  if(!targetShelf || targetShelf === 'ALL') { alert('Select a shelf first'); return; }
  const newName = prompt('New name:', oldName);
  if(!newName || !newName.trim()) return;
  db.ref('items/' + targetShelf + '/' + key).update({ name: newName.trim() });
}

function deleteItem(key, shelfKey){
  const targetShelf = shelfKey || selectedShelfId;
  if(!targetShelf || targetShelf === 'ALL') { alert('Select a shelf first'); return; }
  if(!confirm('Delete this item?')) return;
  db.ref('items/' + targetShelf + '/' + key).remove();
}

/* Search & Sort */
searchInput.addEventListener('input', (e) => {
  currentSearchTerm = e.target.value.toLowerCase();
  renderItems();
});

sortAscBtn.addEventListener('click', () => { 
  currentSortOrder = 'asc';
  renderItems(); 
});

sortDescBtn.addEventListener('click', () => { 
  currentSortOrder = 'desc';
  renderItems(); 
});

/* Export */
exportBtn.addEventListener('click', async () => {
  if(!selectedShelfId){ 
    appStatus.textContent = 'Select a shelf first.'; 
    setTimeout(() => appStatus.textContent = '', 2000); 
    return; 
  }
  const rows = itemsData.map((it, i) => ({
    No: i+1,
    Name: it.name,
    Shelf: it.shelf || (shelves.find(s => s.key === selectedShelfId)?.name || ''),
    InitialStock: it.initialStock,
    StockIn: it.stockIn,
    StockOut: it.stockOut,
    FinalStock: it.finalStock
  }));
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Items');
  const fnameSafe = (selectedShelfId === 'ALL') ? 'all_shelves' : (shelves.find(s => s.key === selectedShelfId)?.name || 'shelf').replace(/[^a-z0-9_\-]/ig,'_');
  XLSX.writeFile(wb, `items_${fnameSafe}.xlsx`);
});

/* PERBAIKAN UTAMA: IMPORT dengan replace data existing */
importBtn.addEventListener('click', async () => {
  if (currentUserRole !== 'admin') { 
    alert('Hanya admin yang bisa import items.'); 
    return; 
  }
  
  if (!selectedShelfId || selectedShelfId === 'ALL') { 
    alert('Pilih rak tertentu sebelum import.'); 
    return; 
  }

  const currentShelf = shelves.find(s => s.key === selectedShelfId);
  if (!currentShelf) { 
    alert('Rak tidak valid'); 
    return; 
  }

  // Konfirmasi mode import
  const importMode = confirm(
    'IMPORT DATA EXCEL:\n\n' +
    'Klik OK untuk: REPLACE semua data di rak ini dengan data dari Excel\n' +
    'Klik Cancel untuk: TAMBAH data baru saja (tanpa menghapus yang lama)\n\n' +
    '⚠️ PERHATIAN: REPLACE akan menghapus semua item yang ada di rak ini!'
  ) ? 'REPLACE' : 'ADD';

  const inp = document.createElement('input');
  inp.type = 'file';
  inp.accept = '.xlsx,.xls,.csv';

  inp.onchange = async (ev) => {
    const file = ev.target.files[0];
    if (!file) return;
    
    appStatus.textContent = 'Membaca file...';

    try {
      const rows = await readFile(file);
      if (!rows || !rows.length) { 
        appStatus.textContent = 'Tidak ada data di file.'; 
        setTimeout(() => appStatus.textContent = '',2500); 
        return; 
      }

      const prepared = prepareImportData(rows);
      if (!prepared.length) { 
        appStatus.textContent = 'Tidak ada baris valid untuk diimport.'; 
        setTimeout(() => appStatus.textContent = '',2500); 
        return; 
      }

      // PERBAIKAN: Jika mode REPLACE, hapus dulu semua item di rak ini
      if (importMode === 'REPLACE') {
        await db.ref('items/' + selectedShelfId).remove();
        appStatus.textContent = 'Data lama dihapus, mengimport data baru...';
      }

      const updates = {};
      let newItemsCount = 0;
      let updatedItemsCount = 0;

      // PERBAIKAN: Cek item yang sudah ada untuk update
      const existingItemsSnapshot = await db.ref('items/' + selectedShelfId).once('value');
      const existingItems = {};
      
      existingItemsSnapshot.forEach(child => {
        const item = child.val();
        existingItems[item.name?.toLowerCase().trim()] = {
          key: child.key,
          data: item
        };
      });

      for (const itemData of prepared) {
        const itemNameLower = itemData.name.toLowerCase().trim();
        
        // PERBAIKAN: Jika item sudah ada, UPDATE data yang ada
        if (existingItems[itemNameLower]) {
          const existingKey = existingItems[itemNameLower].key;
          updates[`items/${selectedShelfId}/${existingKey}`] = {
            ...existingItems[itemNameLower].data, // Pertahankan data lama
            name: itemData.name,
            initialStock: Number(itemData.initialStock), // GANTI dengan nilai dari Excel
            stockIn: Number(itemData.stockIn), // GANTI dengan nilai dari Excel  
            stockOut: Number(itemData.stockOut), // GANTI dengan nilai dari Excel
            finalStock: Number(itemData.finalStock), // GANTI dengan nilai dari Excel
            shelf: currentShelf.name,
            shelfKey: selectedShelfId,
            lastUpdated: Date.now(),
            updatedBy: currentUser?.uid || ''
          };
          updatedItemsCount++;
        } else {
          // Jika item belum ada, BUAT baru
          const newKey = db.ref('items/' + selectedShelfId).push().key;
          updates[`items/${selectedShelfId}/${newKey}`] = {
            name: itemData.name,
            initialStock: Number(itemData.initialStock),
            stockIn: Number(itemData.stockIn),
            stockOut: Number(itemData.stockOut),
            finalStock: Number(itemData.finalStock),
            shelf: currentShelf.name,
            shelfKey: selectedShelfId,
            createdBy: currentUser?.uid || '',
            createdAt: Date.now()
          };
          newItemsCount++;
        }
      }

      await db.ref().update(updates);
      
      // Tampilkan laporan import
      let reportMessage = `Import selesai: `;
      if (importMode === 'REPLACE') {
        reportMessage += `REPLACE data - `;
      } else {
        reportMessage += `ADD data - `;
      }
      reportMessage += `${newItemsCount} item baru, ${updatedItemsCount} item diupdate di rak "${currentShelf.name}"`;
      
      appStatus.textContent = reportMessage;
      setTimeout(() => appStatus.textContent = '', 5000);
      
    } catch (err) {
      console.error('Import error:', err);
      appStatus.textContent = 'Import gagal: ' + (err.message || err);
      setTimeout(() => appStatus.textContent = '', 3500);
    }
  };

  inp.click();
});

// Helper functions for import
function readFile(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    const name = (file.name || '').toLowerCase();
    reader.onerror = () => reject(new Error('Gagal membaca file'));
    
    if (name.endsWith('.csv')) {
      reader.onload = () => {
        try {
          const text = reader.result || '';
          const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
          if (!lines.length) return resolve([]);
          const sep = detectSeparator(text);
          const headers = lines[0].split(sep).map(h => sanitizeHeader(h));
          const out = [];
          for (let i = 1; i < lines.length; i++) {
            const parts = lines[i].split(sep);
            const obj = {};
            for (let j = 0; j < headers.length; j++) {
              const key = headers[j] || ('col' + j);
              obj[key] = (parts[j] !== undefined) ? parts[j].trim() : '';
            }
            out.push(obj);
          }
          resolve(out);
        } catch (e) { reject(e); }
      };
      reader.readAsText(file, 'UTF-8');
    } else {
      reader.onload = () => {
        try {
          const data = new Uint8Array(reader.result);
          const wb = XLSX.read(data, { type: 'array' });
          const out = [];
          wb.SheetNames.forEach(sn => {
            const ws = wb.Sheets[sn];
            const json = XLSX.utils.sheet_to_json(ws, { defval: '' });
            json.forEach(r => out.push(r));
          });
          resolve(out);
        } catch (e) { reject(e); }
      };
      reader.readAsArrayBuffer(file);
    }
  });
}

function prepareImportData(rows) {
  const prepared = [];
  rows.forEach((r) => {
    const rr = normalizeKeys(r);
    delete rr.shelf; 
    delete rr.shelf_key; 
    delete rr.shelfkey;
    
    const name = pickFirst(rr, ['name','nama','item_name','item','nama_barang','product','title']) || '';
    if (!String(name).trim()) return;
    
    // PERBAIKAN: Ambil nilai langsung dari Excel, jangan kalkulasi otomatis
    let initial = pickFirst(rr, ['initial_stock','initialstock','stok_awal','stokawal','stok','stock']);
    initial = parseNumberSafe(initial);
    if (isNaN(initial)) initial = 0;
    
    let inVal = pickFirst(rr, ['stock_in','stockin','masuk','add','in']); 
    inVal = parseNumberSafe(inVal); 
    if (isNaN(inVal)) inVal = 0;
    
    let outVal = pickFirst(rr, ['stock_out','stockout','keluar','out']); 
    outVal = parseNumberSafe(outVal); 
    if (isNaN(outVal)) outVal = 0;
    
    // PERBAIKAN: Final stock diambil dari Excel atau kalkulasi sederhana
    let finalStock = pickFirst(rr, ['final_stock','finalstock','stok_akhir','stokakhir','current_stock']);
    if (finalStock === undefined) {
      finalStock = Math.max(0, initial + inVal - outVal);
    } else {
      finalStock = parseNumberSafe(finalStock);
      if (isNaN(finalStock)) finalStock = Math.max(0, initial + inVal - outVal);
    }
    
    prepared.push({
      name: String(name).trim(),
      initialStock: Number(initial),
      stockIn: Number(inVal),
      stockOut: Number(outVal),
      finalStock: Number(finalStock)
    });
  });
  return prepared;
}

function detectSeparator(text){
  const first = text.split(/\r?\n/)[0] || '';
  if(first.indexOf(';') !== -1) return ';';
  if(first.indexOf(',') !== -1) return ',';
  if(first.indexOf('\t') !== -1) return '\t';
  return ',';
}

function sanitizeHeader(h){ 
  if(h === undefined || h === null) return ''; 
  return String(h).toLowerCase().replace(/\s+/g,'_').replace(/[^a-z0-9_]/g,'').trim(); 
}

function normalizeKeys(obj){ 
  const out = {}; 
  for(const k in obj){ 
    const sk = sanitizeHeader(k); 
    out[sk||k] = obj[k]; 
  } 
  return out; 
}

function pickFirst(obj, candidates){ 
  for(const c of candidates){ 
    if(obj[c] !== undefined && obj[c] !== null && String(obj[c]).toString().trim() !== '') 
      return obj[c]; 
  } 
  return undefined; 
}

function parseNumberSafe(v){ 
  if(v === null || v === undefined) return NaN; 
  if(typeof v === 'number') return v; 
  let s = String(v).trim(); 
  if(s === '') return NaN; 
  s = s.replace(/,/g,''); 
  const dots = (s.match(/\./g) || []).length; 
  if(dots > 1) s = s.replace(/\./g,''); 
  const n = Number(s); 
  return isNaN(n) ? NaN : n; 
}

/* Delete all items */
deleteAllBtn.addEventListener('click', async () => {
  if(currentUserRole !== 'admin'){ alert('Only admin can delete all items'); return; }
  if(!selectedShelfId || selectedShelfId === 'ALL'){ alert('Select a single shelf to delete all items.'); return; }
  if(!confirm('Delete ALL items in this shelf? This cannot be undone.')) return;
  try {
    await db.ref('items/' + selectedShelfId).remove();
    appStatus.textContent = 'All items deleted from shelf.';
    setTimeout(() => appStatus.textContent = '', 2500);
  } catch(err){
    appStatus.textContent = 'Delete failed: ' + (err.message || err);
    setTimeout(() => appStatus.textContent = '', 2500);
  }
});

/* Delete account */
deleteAccountBtn.addEventListener('click', async () => {
  const user = auth.currentUser;
  if(!user){ alert('No signed-in user'); return; }
  if(!confirm('Delete your account? This will remove your authentication record and your user metadata.')) return;
  try {
    await db.ref('users/' + user.uid).remove();
    await user.delete();
    alert('Account deleted.');
    location.reload();
  } catch(err) {
    if(err && err.code === 'auth/requires-recent-login'){
      const pwd = prompt('For security please enter your password to confirm deletion:');
      if(!pwd){ alert('Password required to reauthenticate.'); return; }
      try {
        const credential = firebase.auth.EmailAuthProvider.credential(user.email, pwd);
        await user.reauthenticateWithCredential(credential);
        await db.ref('users/' + user.uid).remove();
        await user.delete();
        alert('Account deleted.');
        location.reload();
      } catch(e){
        alert('Reauthentication failed: ' + (e.message || e));
      }
    } else {
      alert('Account deletion failed: ' + (err.message || err));
    }
  }
});

/* Quick Actions */
quickAddItemBtn.addEventListener('click', () => {
  addNewItem();
});

quickViewStatsBtn.addEventListener('click', () => {
  showMonthlyStats();
});

quickLowStockBtn.addEventListener('click', () => {
  // Filter untuk low stock
  const lowStockItems = itemsData.filter(item => item.finalStock <= LOW_STOCK_THRESHOLD && item.finalStock > 0);
  renderFilteredItems(lowStockItems);
});

quickZeroStockBtn.addEventListener('click', () => {
  // Filter untuk zero stock
  const zeroStockItems = itemsData.filter(item => item.finalStock <= 0);
  renderFilteredItems(zeroStockItems);
});

// PERBAIKAN: Fungsi untuk merender item yang sudah difilter
function renderFilteredItems(filteredItems) {
  let itemsToRender = [...filteredItems];
  
  // Apply search filter
  if (currentSearchTerm) {
    itemsToRender = itemsToRender.filter(i => (i.name || '').toLowerCase().includes(currentSearchTerm));
  }
  
  // Apply sort
  if (currentSortOrder === 'asc') {
    itemsToRender.sort((a,b) => (a.name||'').localeCompare(b.name||''));
  } else {
    itemsToRender.sort((a,b) => (b.name||'').localeCompare(a.name||''));
  }
  
  renderItemsList(itemsToRender);
}

// PERBAIKAN: Fungsi untuk merender daftar item
function renderItemsList(itemsToRender) {
  itemsTable.innerHTML = '';
  
  itemsToRender.forEach((item, idx) => {
    const tr = document.createElement('tr');
    tr.className = 'clickable-row';
    if (item.finalStock <= LOW_STOCK_THRESHOLD) {
      tr.classList.add('low-stock-row');
    }
    
    tr.addEventListener('click', (e) => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') return;
      document.querySelectorAll('.clickable-row.active').forEach(row => row.classList.remove('active'));
      tr.classList.add('active');
      showItemDetail(item);
    });

    const tdNo = document.createElement('td'); 
    tdNo.textContent = idx + 1;
    
    const tdName = document.createElement('td'); 
    tdName.textContent = item.name || ''; 
    tdName.style.textAlign = 'left';
    
    if (item.finalStock <= LOW_STOCK_THRESHOLD) {
      const warningText = document.createElement('div');
      warningText.className = 'stock-warning';
      warningText.textContent = '⚠️ LOW STOCK - NEED TO RESTOCK';
      tdName.appendChild(warningText);
    }

    const tdInitial = document.createElement('td'); 
    tdInitial.textContent = item.initialStock || 0;

    const tdIn = document.createElement('td');
    const inInput = document.createElement('input'); 
    inInput.type = 'number'; 
    inInput.min = 0; 
    inInput.value = 0;
    inInput.className = 'num-input';
    tdIn.appendChild(inInput);

    const tdOut = document.createElement('td');
    const outInput = document.createElement('input'); 
    outInput.type = 'number'; 
    outInput.min = 0; 
    outInput.value = 0;
    outInput.className = 'num-input';
    tdOut.appendChild(outInput);

    const tdShelf = document.createElement('td'); 
    tdShelf.className = 'col-shelf';
    tdShelf.textContent = item.shelf || '—';

    const tdFinal = document.createElement('td');
    const finalBadge = document.createElement('span'); 
    finalBadge.className = 'badge';
    const orderFlag = document.createElement('span'); 
    
    if (item.finalStock <= 0) {
      finalBadge.className = 'badge badge-low';
      orderFlag.className = 'order-flag'; 
      orderFlag.textContent = 'OUT OF STOCK';
    } else if (item.finalStock <= LOW_STOCK_THRESHOLD) {
      finalBadge.className = 'badge badge-warning';
      orderFlag.className = 'warning-flag'; 
      orderFlag.textContent = 'LOW STOCK';
    } else {
      finalBadge.className = 'badge badge-ok';
      orderFlag.className = 'order-flag'; 
      orderFlag.textContent = '';
    }
    
    finalBadge.textContent = item.finalStock || 0;
    tdFinal.appendChild(finalBadge);
    tdFinal.appendChild(orderFlag);

    const tdAction = document.createElement('td'); 
    tdAction.className = 'row-actions';

    // History button
    const historyBtn = document.createElement('button');
    historyBtn.innerHTML = '<i class="fas fa-history"></i>';
    historyBtn.className = 'btn btn-primary btn-small';
    historyBtn.title = 'Show history for this item';
    historyBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      showHistory(item.shelfKey || selectedShelfId, item.key, item.name);
    });
    tdAction.appendChild(historyBtn);

    // Apply button
    const applyBtn = document.createElement('button');
    applyBtn.innerHTML = '<i class="fas fa-check"></i>';
    applyBtn.className = 'btn btn-secondary btn-small';
    applyBtn.title = 'Apply changes';
    applyBtn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const inVal = parseInt(inInput.value || 0, 10) || 0;
      const outVal = parseInt(outInput.value || 0, 10) || 0;
      const targetShelfKey = item.shelfKey || selectedShelfId;

      if (inVal === 0 && outVal === 0) {
        appStatus.textContent = 'No changes to apply';
        setTimeout(() => appStatus.textContent = '', 1400);
        return;
      }

      try {
        const newFinal = Math.max(0, (Number(item.finalStock || 0) + inVal - outVal));
        
        await db.ref('items/' + targetShelfKey + '/' + item.key).update({
          stockIn: inVal,
          stockOut: outVal,
          finalStock: newFinal
        });

        // PERBAIKAN UTAMA: Panggil fungsi email dengan cooldown 30 menit
        if (newFinal <= LOW_STOCK_THRESHOLD) {
          await sendLowStockEmailWithCooldown(item.name, newFinal, targetShelfKey, item.key);
        }

        const historyData = {
          type: 'apply',
          itemName: item.name,
          stockIn: inVal,
          stockOut: outVal,
          initialStock: item.initialStock,
          finalStockBefore: item.finalStock,
          finalStockAfter: newFinal,
          userId: currentUser?.uid || '',
          userEmail: currentUser?.email || '',
          timestamp: Date.now(),
          month: new Date().getMonth() + 1,
          year: new Date().getFullYear()
        };

        const historyRef = db.ref('history/' + targetShelfKey + '/' + item.key).push();
        await historyRef.set(historyData);

        // PERBAIKAN UTAMA: Reset input fields setelah apply berhasil
        inInput.value = 0;
        outInput.value = 0;
        
        appStatus.textContent = 'Apply completed - History added';
        if (newFinal <= LOW_STOCK_THRESHOLD) {
          appStatus.textContent += ' - Low stock alert sent';
        }
        setTimeout(() => appStatus.textContent = '', 1400);

      } catch(err) {
        console.error('Apply error:', err);
        appStatus.textContent = 'Apply failed: ' + err.message;
        setTimeout(() => appStatus.textContent = '', 2000);
      }
    });

    if(currentUserRole === 'admin'){
      const editBtn = document.createElement('button'); 
      editBtn.innerHTML = '<i class="fas fa-edit"></i>';
      editBtn.className = 'btn btn-secondary btn-small';
      editBtn.title = 'Edit item';
      editBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        editItemName(item.key, item.name, item.shelfKey);
      });
      const deleteBtn = document.createElement('button'); 
      deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
      deleteBtn.className = 'btn btn-danger btn-small';
      deleteBtn.title = 'Delete item';
      deleteBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        deleteItem(item.key, item.shelfKey);
      });
      tdAction.appendChild(editBtn); 
      tdAction.appendChild(deleteBtn);
    }

    inInput.addEventListener('input', () => computePreview(item, inInput, outInput, finalBadge, orderFlag));
    outInput.addEventListener('input', () => computePreview(item, inInput, outInput, finalBadge, orderFlag));

    tdAction.appendChild(applyBtn);

    tr.appendChild(tdNo);
    tr.appendChild(tdName);
    tr.appendChild(tdInitial);
    tr.appendChild(tdIn);
    tr.appendChild(tdOut);
    tr.appendChild(tdShelf);
    tr.appendChild(tdFinal);
    tr.appendChild(tdAction);
    itemsTable.appendChild(tr);
  });
}

/* Clear Filters */
clearFiltersBtn.addEventListener('click', () => {
  // PERBAIKAN: Hanya reset search dan sort, shelf tetap sama
  currentSearchTerm = '';
  searchInput.value = '';
  currentSortOrder = 'asc';
  renderItems();
});

/* PERBAIKAN UTAMA: Setup Warehouse Team Management */
function setupWarehouseTeam() {
  const teamData = {
    member1: {
      email: 'helpdesk.kpc@gmail.com',
      name: 'Stock Manager',
      role: 'manager',
      active: true
    },
    member2: {
      email: 'sayaaqilkamal@gmail.com',
      name: 'Warehouse Staff 2', 
      role: 'staff',
      active: true
    },
    member3: {
      email: 'staff3@example.com',
      name: 'Warehouse Staff 3',
      role: 'staff',
      active: true
    },
    member4: {
      email: 'staff4@example.com',
      name: 'Warehouse Staff 4',
      role: 'staff',
      active: true
    },
    member5: {
      email: 'staff5@example.com',
      name: 'Warehouse Staff 5',
      role: 'staff',
      active: true
    }
  };

  db.ref('warehouseTeam').set(teamData)
    .then(() => console.log('✅ Warehouse team setup completed'))
    .catch(error => console.error('❌ Setup failed:', error));
}

// Panggil setup warehouse team saat app dimulai
setupWarehouseTeam();

/* PERBAIKAN UTAMA: Fungsi untuk View Stats */
function showMonthlyStats() {
  // Buka modal stats
  statsModal.classList.add('open');
  
  // Load data untuk charts
  loadChartsData();
  
  // Setup tab navigation
  setupStatsTabs();
  
  // Setup chart open buttons
  setupChartOpenButtons();
}

function setupStatsTabs() {
  const tabs = document.querySelectorAll('.stats-tab');
  const tabContents = document.querySelectorAll('.stats-tab-content');
  
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      // Remove active class from all tabs and contents
      tabs.forEach(t => t.classList.remove('active'));
      tabContents.forEach(c => c.classList.remove('active'));
      
      // Add active class to clicked tab
      tab.classList.add('active');
      
      // Show corresponding content
      const tabId = tab.getAttribute('data-tab');
      document.getElementById(`${tabId}-tab`).classList.add('active');
    });
  });
}

function setupChartOpenButtons() {
  const openButtons = document.querySelectorAll('.chart-open-btn');
  
  openButtons.forEach(button => {
    button.addEventListener('click', () => {
      const chartType = button.getAttribute('data-chart-type');
      openFullChart(chartType);
    });
  });
}

function openFullChart(chartType) {
  // Create a new modal for full chart view
  const fullChartModal = document.createElement('div');
  fullChartModal.id = 'full-chart-modal';
  fullChartModal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10001;
    padding: 20px;
  `;
  
  const fullChartContent = document.createElement('div');
  fullChartContent.style.cssText = `
    background: white;
    border-radius: 12px;
    width: 95%;
    height: 90%;
    max-width: 1400px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    overflow: hidden;
  `;
  
  const fullChartHeader = document.createElement('div');
  fullChartHeader.style.cssText = `
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 2px solid #eee;
    background: #f8f8f8;
    flex-shrink: 0;
  `;
  
  const fullChartTitle = document.createElement('h2');
  fullChartTitle.textContent = getChartTitle(chartType) + ' - Full View';
  fullChartTitle.style.cssText = `
    font-size: 24px;
    font-weight: 700;
    color: #333;
    margin: 0;
  `;
  
  const fullChartClose = document.createElement('button');
  fullChartClose.innerHTML = '<i class="fas fa-times"></i> Close';
  fullChartClose.style.cssText = `
    background: #d32f2f;
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
  `;
  
  // PERBAIKAN: Event listener untuk tombol close
  fullChartClose.addEventListener('click', function() {
    // Hapus modal dari DOM
    if (document.body.contains(fullChartModal)) {
      document.body.removeChild(fullChartModal);
    }
    // Destroy chart instance
    if (window.fullChartInstance) {
      window.fullChartInstance.destroy();
      window.fullChartInstance = null;
    }
  });
  
  // PERBAIKAN: Event listener untuk klik di luar modal
  fullChartModal.addEventListener('click', function(e) {
    if (e.target === fullChartModal) {
      if (document.body.contains(fullChartModal)) {
        document.body.removeChild(fullChartModal);
      }
      if (window.fullChartInstance) {
        window.fullChartInstance.destroy();
        window.fullChartInstance = null;
      }
    }
  });
  
  const fullChartBody = document.createElement('div');
  fullChartBody.style.cssText = `
    flex: 1;
    padding: 20px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    min-height: 0;
  `;
  
  const fullChartContainer = document.createElement('div');
  fullChartContainer.style.cssText = `
    position: relative;
    width: 100%;
    height: 100%;
    overflow-x: auto;
    overflow-y: hidden;
    background: #f9f9f9;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
    scroll-behavior: smooth;
    flex: 1;
  `;
  
  const fullChartWrapper = document.createElement('div');
  fullChartWrapper.style.cssText = `
    position: relative;
    height: 100%;
    padding: 20px;
    min-width: ${Math.max(800, itemsData.length * 60)}px;
  `;
  
  const fullChartCanvas = document.createElement('canvas');
  fullChartCanvas.id = 'full-chart-canvas';
  
  fullChartWrapper.appendChild(fullChartCanvas);
  fullChartContainer.appendChild(fullChartWrapper);
  fullChartBody.appendChild(fullChartContainer);
  
  fullChartHeader.appendChild(fullChartTitle);
  fullChartHeader.appendChild(fullChartClose);
  fullChartContent.appendChild(fullChartHeader);
  fullChartContent.appendChild(fullChartBody);
  fullChartModal.appendChild(fullChartContent);
  
  document.body.appendChild(fullChartModal);
  
  // Render the full chart
  renderFullChart(chartType, fullChartCanvas);
}

function getChartTitle(chartType) {
  switch(chartType) {
    case 'stock-in': return 'Stock In';
    case 'stock-out': return 'Stock Out';
    case 'current-stock': return 'Current Stock';
    default: return 'Stock Chart';
  }
}

function renderFullChart(chartType, canvas) {
  const ctx = canvas.getContext('2d');
  
  // Destroy existing chart if any
  if (window.fullChartInstance) {
    window.fullChartInstance.destroy();
  }
  
  const data = prepareChartData(chartType);
  const chartConfig = getChartConfig(itemsData.length);
  
  window.fullChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: data.labels,
      datasets: [{
        label: getChartTitle(chartType),
        data: data.values,
        backgroundColor: getChartColor(chartType),
        borderColor: getChartBorderColor(chartType),
        borderWidth: 1,
        barThickness: chartConfig.barThickness,
        maxBarThickness: chartConfig.maxBarThickness,
        categoryPercentage: chartConfig.categoryPercentage,
        barPercentage: chartConfig.barPercentage
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: getChartTitle(chartType) + ' - All Items',
          font: {
            size: 18
          }
        },
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `${context.dataset.label}: ${context.parsed.y}`;
            }
          }
        }
      },
      scales: {
        x: {
          ticks: {
            font: {
              size: chartConfig.xAxisFontSize
            },
            maxRotation: chartConfig.labelRotation,
            minRotation: chartConfig.labelRotation,
            autoSkip: chartConfig.autoSkip
          },
          title: {
            display: true,
            text: 'Items'
          }
        },
        y: {
          beginAtZero: true,
          ticks: {
            font: {
              size: chartConfig.yAxisFontSize
            }
          },
          title: {
            display: true,
            text: 'Quantity'
          }
        }
      }
    }
  });
}

function loadChartsData() {
  // Prepare data for all three charts
  const stockInData = prepareChartData('stock-in');
  const stockOutData = prepareChartData('stock-out');
  const currentStockData = prepareChartData('current-stock');
  
  // Render all charts
  renderChart('stock-in-chart', 'Stock In', stockInData, '#4caf50');
  renderChart('stock-out-chart', 'Stock Out', stockOutData, '#f44336');
  renderChart('current-stock-chart', 'Current Stock', currentStockData, '#2196f3');
}

function prepareChartData(chartType) {
  let labels = [];
  let values = [];
  
  // Sort items by name for consistent display
  const sortedItems = [...itemsData].sort((a, b) => (a.name || '').localeCompare(b.name || ''));
  
  sortedItems.forEach(item => {
    labels.push(item.name || 'Unnamed Item');
    
    switch(chartType) {
      case 'stock-in':
        values.push(item.stockIn || 0);
        break;
      case 'stock-out':
        values.push(item.stockOut || 0);
        break;
      case 'current-stock':
        values.push(item.finalStock || 0);
        break;
      default:
        values.push(0);
    }
  });
  
  return { labels, values };
}

function getChartColor(chartType) {
  switch(chartType) {
    case 'stock-in': return '#4caf50';
    case 'stock-out': return '#f44336';
    case 'current-stock': return '#2196f3';
    default: return '#666666';
  }
}

function getChartBorderColor(chartType) {
  switch(chartType) {
    case 'stock-in': return '#388e3c';
    case 'stock-out': return '#d32f2f';
    case 'current-stock': return '#1976d2';
    default: return '#333333';
  }
}

function renderChart(canvasId, title, data, color) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  
  // Destroy existing chart if any
  if (window[canvasId + 'Instance']) {
    window[canvasId + 'Instance'].destroy();
  }
  
  const chartConfig = getChartConfig(itemsData.length);
  
  window[canvasId + 'Instance'] = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: data.labels,
      datasets: [{
        label: title,
        data: data.values,
        backgroundColor: color,
        borderColor: color,
        borderWidth: 1,
        barThickness: chartConfig.barThickness,
        maxBarThickness: chartConfig.maxBarThickness,
        categoryPercentage: chartConfig.categoryPercentage,
        barPercentage: chartConfig.barPercentage
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: title,
          font: {
            size: 16
          }
        },
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `${context.dataset.label}: ${context.parsed.y}`;
            }
          }
        }
      },
      scales: {
        x: {
          ticks: {
            font: {
              size: chartConfig.xAxisFontSize
            },
            maxRotation: chartConfig.labelRotation,
            minRotation: chartConfig.labelRotation,
            autoSkip: chartConfig.autoSkip
          }
        },
        y: {
          beginAtZero: true,
          ticks: {
            font: {
              size: chartConfig.yAxisFontSize
            }
          }
        }
      }
    }
  });
}

function getChartConfig(itemCount) {
  let config = {
    barThickness: 'flex',
    maxBarThickness: 40,
    categoryPercentage: 0.8,
    barPercentage: 0.9,
    xAxisFontSize: 11,
    yAxisFontSize: 12,
    tooltipFontSize: 12,
    labelRotation: 45,
    autoSkip: false
  };
  
  if (itemCount <= 20) {
    config.maxBarThickness = 50;
    config.xAxisFontSize = 12;
    config.labelRotation = 0;
  } else if (itemCount <= 50) {
    config.maxBarThickness = 40;
    config.xAxisFontSize = 11;
    config.labelRotation = 45;
  } else if (itemCount <= 100) {
    config.maxBarThickness = 35;
    config.xAxisFontSize = 10;
    config.labelRotation = 45;
  } else if (itemCount <= 300) {
    config.maxBarThickness = 30;
    config.xAxisFontSize = 9;
    config.labelRotation = 45;
  } else {
    config.maxBarThickness = 25;
    config.xAxisFontSize = 8;
    config.labelRotation = 45;
  }
  
  return config;
}

// Close stats modal
statsModalClose.addEventListener('click', () => {
  statsModal.classList.remove('open');
});

// Close stats modal when clicking outside
statsModal.addEventListener('click', (e) => {
  if (e.target === statsModal) {
    statsModal.classList.remove('open');
  }
});

// Event listener untuk quick view stats
quickViewStatsBtn.addEventListener('click', showMonthlyStats);
</script>
</body>
</html>